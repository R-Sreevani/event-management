{% extends 'layout.html' %}
{% block title %}Event Registrations - {{ event.name }}{% endblock %}

{% block extra_css %}
<style>
    .export-btn {
        background: linear-gradient(135deg, #28a745, #1e7e34);
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 5px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .export-btn:hover {
        background: linear-gradient(135deg, #218838, #1c7430);
        color: white;
        text-decoration: none;
    }
    
    .attendance-btn {
        padding: 3px 10px;
        border-radius: 4px;
        border: none;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .present-btn { background: #d4edda; color: #155724; }
    .absent-btn { background: #f8d7da; color: #721c24; }
    .present-btn:hover { background: #c3e6cb; }
    .absent-btn:hover { background: #f5c6cb; }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="cuk-text-primary">
            <i class="bi bi-people me-2"></i>Event Registrations
        </h1>
        <p class="text-muted">{{ event.name }}</p>
        <div class="d-flex align-items-center gap-3 mb-3">
            <span class="badge bg-primary">{{ event.category|title }}</span>
            <span><i class="bi bi-calendar me-1"></i>{{ event.date.strftime('%d %b %Y') }}</span>
            <span><i class="bi bi-geo-alt me-1"></i>{{ event.venue }}</span>
            <span class="text-muted">{{ registrations|length }}/{{ event.capacity }} registered</span>
        </div>
    </div>
    <div class="col-md-4 text-end">
        <a href="{{ url_for('export_registrations', event_id=event.id) }}" class="export-btn">
            <i class="bi bi-download me-1"></i>Export as CSV
        </a>
        <a href="{{ url_for('admin_events') }}" class="btn btn-outline-primary ms-2">
            <i class="bi bi-arrow-left me-1"></i>Back to Events
        </a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        {% if registrations %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Registration No</th>
                            <th>Department</th>
                            <th>Registered At</th>
                            <th>Attendance</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for reg in registrations %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="ms-2">
                                            <div>{{ reg.user.name }}</div>
                                            {% if reg.user.phone %}
                                                <small class="text-muted">{{ reg.user.phone }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>{{ reg.user.email }}</td>
                                <td>{{ reg.user.registration_no or 'N/A' }}</td>
                                <td>
                                    {% if reg.user.department %}
                                        <span class="badge bg-info">{{ reg.user.department.code }}</span>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>{{ reg.registered_at.strftime('%d %b %Y %H:%M') }}</td>
                                <td>
                                    <span class="badge 
                                        {% if reg.attendance_status == 'Present' %}bg-success
                                        {% elif reg.attendance_status == 'Absent' %}bg-danger
                                        {% else %}bg-secondary{% endif %}">
                                        {{ reg.attendance_status }}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="attendance-btn present-btn" 
                                                onclick="updateAttendance({{ reg.id }}, 'Present')"
                                                title="Mark as Present">
                                            <i class="bi bi-check-circle"></i>
                                        </button>
                                        <button class="attendance-btn absent-btn"
                                                onclick="updateAttendance({{ reg.id }}, 'Absent')"
                                                title="Mark as Absent">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Summary Statistics -->
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="card border-primary">
                        <div class="card-body text-center">
                            <h3 class="text-primary">{{ registrations|length }}</h3>
                            <p class="text-muted mb-0">Total Registered</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <h3 class="text-success">
                                {{ registrations|selectattr('attendance_status', 'equalto', 'Present')|list|length }}
                            </h3>
                            <p class="text-muted mb-0">Present</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-danger">
                        <div class="card-body text-center">
                            <h3 class="text-danger">
                                {{ registrations|selectattr('attendance_status', 'equalto', 'Absent')|list|length }}
                            </h3>
                            <p class="text-muted mb-0">Absent</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-secondary">
                        <div class="card-body text-center">
                            <h3 class="text-secondary">
                                {{ registrations|selectattr('attendance_status', 'equalto', 'Registered')|list|length }}
                            </h3>
                            <p class="text-muted mb-0">Not Marked</p>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-people-slash fs-1 text-muted mb-3"></i>
                <h4 class="text-muted">No Registrations Yet</h4>
                <p class="text-muted">No one has registered for this event yet.</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
function updateAttendance(registrationId, status) {
    if (confirm(`Mark attendance as ${status}?`)) {
        fetch(`/api/attendance/${registrationId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: status })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to update attendance');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update attendance');
        });
    }
}

// Add this route to your app.py if not already present
/*
@app.route('/api/attendance/<int:registration_id>', methods=['PUT'])
@admin_required
def update_attendance(registration_id):
    registration = Registration.query.get_or_404(registration_id)
    data = request.json
    registration.attendance_status = data.get('status', 'Registered')
    db.session.commit()
    return jsonify({'success': True})
*/
</script>
{% endblock %}
