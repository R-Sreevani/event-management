{% extends 'layout.html' %}
{% block title %}Register{% endblock %}

{% block content %}
<div class="form-container">
    <h2 class="form-title">üìù Create Your Account</h2>
    
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {% for message in messages %}
                    {{ message }}
                {% endfor %}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endif %}
    {% endwith %}
    
    <form method="POST" id="registerForm" class="register-form">
        <div class="form-grid">
            <div class="form-group">
                <label for="name">Full Name</label>
                <input type="text" name="name" id="name" required 
                       placeholder="Enter your full name"
                       class="form-input">
                <div class="input-hint">Use your official name as per university records</div>
            </div>
            
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" name="email" id="email" required 
                       placeholder="your.email@university.edu"
                       class="form-input"
                       onblur="validateEmail()">
                <div class="input-hint">University email preferred</div>
                <div id="email-error" class="error-message"></div>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <div class="password-container">
                    <input type="password" name="password" id="password" required 
                           placeholder="Create a strong password"
                           class="form-input"
                           onkeyup="checkPasswordStrength()">
                    <span class="toggle-password" onclick="togglePassword()">üëÅÔ∏è</span>
                </div>
                <div id="password-strength" class="strength-meter">
                    <div class="strength-bar"></div>
                    <div class="strength-text">Password strength: <span id="strength-text">None</span></div>
                </div>
                <div class="password-requirements">
                    <ul>
                        <li id="req-length">At least 8 characters</li>
                        <li id="req-uppercase">One uppercase letter</li>
                        <li id="req-lowercase">One lowercase letter</li>
                        <li id="req-number">One number</li>
                        <li id="req-special">One special character</li>
                    </ul>
                </div>
            </div>
            
            <div class="form-group">
                <label for="confirm-password">Confirm Password</label>
                <div class="password-container">
                    <input type="password" id="confirm-password" required 
                           placeholder="Re-enter your password"
                           class="form-input"
                           onkeyup="checkPasswordMatch()">
                    <span class="toggle-password" onclick="toggleConfirmPassword()">üëÅÔ∏è</span>
                </div>
                <div id="password-match" class="error-message"></div>
            </div>
            
            <div class="form-group">
                <label for="role">Account Type</label>
                <div class="role-selection">
                    <div class="role-option" onclick="selectRole('student')">
                        <input type="radio" name="role" id="role-student" value="student" checked>
                        <label for="role-student" class="role-label">
                            <div class="role-icon">üéì</div>
                            <div class="role-info">
                                <div class="role-title">Student</div>
                                <div class="role-desc">Register for events, view schedules, join activities</div>
                            </div>
                        </label>
                    </div>
                    
                    <div class="role-option" onclick="selectRole('admin')">
                        <input type="radio" name="role" id="role-admin" value="admin">
                        <label for="role-admin" class="role-label">
                            <div class="role-icon">üõ†Ô∏è</div>
                            <div class="role-info">
                                <div class="role-title">Admin</div>
                                <div class="role-desc">Create events, manage registrations, view analytics</div>
                            </div>
                        </label>
                    </div>
                </div>
                <div class="admin-note" id="admin-note" style="display: none;">
                    ‚ö†Ô∏è Only one admin account is allowed. Admin registration is restricted.
                </div>
            </div>
            
            <div class="form-group terms-group">
                <label class="terms-label">
                    <input type="checkbox" name="terms" id="terms" required>
                    <span>I agree to the <a href="#" onclick="showTerms()">Terms of Service</a> and <a href="#" onclick="showPrivacy()">Privacy Policy</a></span>
                </label>
            </div>
            
            <button type="submit" class="submit-btn" id="submit-btn">
                <span class="btn-text">Create Account</span>
                <span class="btn-spinner" style="display: none;">
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                    Creating account...
                </span>
            </button>
        </div>
    </form>
    
    <div class="demo-accounts">
        <h4>üí° Quick Test Accounts:</h4>
        <div class="demo-grid">
            <div class="demo-card">
                <div class="demo-title">Admin Account</div>
                <div class="demo-email">admin@example.com</div>
                <div class="demo-password">admin123</div>
                <button class="demo-fill-btn" onclick="fillDemo('admin')">Use This</button>
            </div>
            <div class="demo-card">
                <div class="demo-title">Student Account</div>
                <div class="demo-email">student@example.com</div>
                <div class="demo-password">student123</div>
                <button class="demo-fill-btn" onclick="fillDemo('student')">Use This</button>
            </div>
        </div>
        <p class="demo-note">Already have an account? <a href="{{ url_for('login') }}">Login here</a></p>
    </div>
</div>

<style>
    .form-container {
        max-width: 700px;
        margin: 40px auto;
        padding: 40px;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        animation: fadeIn 0.8s ease-out;
        border: 1px solid #e0e0e0;
    }

    .form-title {
        text-align: center;
        color: #6a1b9a;
        font-size: 32px;
        margin-bottom: 30px;
        font-weight: bold;
        background: linear-gradient(135deg, #6a1b9a, #9c4dcc);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .form-grid {
        display: grid;
        gap: 25px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #444;
        font-size: 15px;
    }

    .form-input {
        width: 100%;
        padding: 15px 20px;
        font-size: 16px;
        border-radius: 12px;
        border: 2px solid #e0e0e0;
        transition: all 0.3s;
        background: #fff;
    }

    .form-input:focus {
        border-color: #7e57c2;
        box-shadow: 0 0 0 3px rgba(126, 87, 194, 0.1);
        outline: none;
    }

    .input-hint {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
        margin-left: 5px;
    }

    .password-container {
        position: relative;
    }

    .toggle-password {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        font-size: 18px;
        color: #666;
        user-select: none;
        background: white;
        padding: 5px;
        border-radius: 4px;
    }

    .toggle-password:hover {
        color: #7e57c2;
        background: #f5f5f5;
    }

    .strength-meter {
        margin-top: 10px;
        background: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        height: 8px;
    }

    .strength-bar {
        height: 100%;
        width: 0%;
        background: #ff4444;
        border-radius: 10px;
        transition: all 0.3s;
    }

    .strength-text {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
        text-align: center;
    }

    .password-requirements {
        margin-top: 15px;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #e0e0e0;
    }

    .password-requirements ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 8px;
    }

    .password-requirements li {
        font-size: 12px;
        color: #999;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .password-requirements li:before {
        content: "‚úó";
        color: #ff4444;
    }

    .password-requirements li.valid {
        color: #00C851;
    }

    .password-requirements li.valid:before {
        content: "‚úì";
        color: #00C851;
    }

    .error-message {
        color: #ff4444;
        font-size: 12px;
        margin-top: 5px;
        min-height: 18px;
    }

    .role-selection {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .role-option {
        position: relative;
    }

    .role-option input[type="radio"] {
        display: none;
    }

    .role-label {
        display: flex;
        align-items: center;
        padding: 20px;
        background: #f8f9fa;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        gap: 15px;
    }

    .role-option input[type="radio"]:checked + .role-label {
        background: linear-gradient(135deg, #f3e5f5, #e1bee7);
        border-color: #7e57c2;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(126, 87, 194, 0.1);
    }

    .role-icon {
        font-size: 32px;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border-radius: 10px;
    }

    .role-info {
        flex: 1;
    }

    .role-title {
        font-weight: bold;
        color: #333;
        font-size: 16px;
        margin-bottom: 5px;
    }

    .role-desc {
        font-size: 12px;
        color: #666;
        line-height: 1.4;
    }

    .admin-note {
        background: #fff3cd;
        border: 1px solid #ffc107;
        color: #856404;
        padding: 12px;
        border-radius: 8px;
        margin-top: 10px;
        font-size: 13px;
        animation: slideDown 0.3s ease-out;
    }

    .terms-group {
        margin-top: 10px;
    }

    .terms-label {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #555;
        font-size: 14px;
        cursor: pointer;
    }

    .terms-label input {
        width: 18px;
        height: 18px;
    }

    .terms-label a {
        color: #7e57c2;
        text-decoration: none;
    }

    .terms-label a:hover {
        text-decoration: underline;
    }

    .submit-btn {
        width: 100%;
        padding: 18px;
        background: linear-gradient(135deg, #7e57c2, #5e35b1);
        color: white;
        font-size: 18px;
        font-weight: bold;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .submit-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(126, 87, 194, 0.3);
        background: linear-gradient(135deg, #6a1b9a, #4a148c);
    }

    .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .demo-accounts {
        margin-top: 40px;
        padding-top: 30px;
        border-top: 2px dashed #e0e0e0;
    }

    .demo-accounts h4 {
        text-align: center;
        color: #1976d2;
        margin-bottom: 20px;
        font-size: 18px;
    }

    .demo-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .demo-card {
        background: #e3f2fd;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #bbdefb;
    }

    .demo-title {
        font-weight: bold;
        color: #1976d2;
        margin-bottom: 10px;
        font-size: 16px;
    }

    .demo-email, .demo-password {
        font-family: monospace;
        font-size: 13px;
        color: #333;
        margin-bottom: 5px;
        padding: 5px 10px;
        background: white;
        border-radius: 6px;
        border: 1px solid #bbdefb;
    }

    .demo-fill-btn {
        width: 100%;
        padding: 8px;
        background: white;
        color: #1976d2;
        border: 2px solid #1976d2;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 10px;
        font-weight: bold;
        transition: all 0.3s;
    }

    .demo-fill-btn:hover {
        background: #1976d2;
        color: white;
        transform: translateY(-2px);
    }

    .demo-note {
        text-align: center;
        color: #666;
        font-size: 14px;
        margin-top: 15px;
    }

    .demo-note a {
        color: #7e57c2;
        font-weight: bold;
        text-decoration: none;
    }

    .demo-note a:hover {
        text-decoration: underline;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
    }

    .shake {
        animation: shake 0.5s ease-in-out;
    }

    @media (max-width: 768px) {
        .form-container {
            padding: 25px 20px;
            margin: 20px;
        }
        
        .role-selection {
            grid-template-columns: 1fr;
        }
        
        .demo-grid {
            grid-template-columns: 1fr;
        }
        
        .password-requirements ul {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    let passwordValid = false;
    let passwordsMatch = false;
    let emailValid = false;
    
    function togglePassword() {
        const passwordInput = document.getElementById('password');
        const toggleButton = document.querySelector('.toggle-password');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleButton.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è';
        } else {
            passwordInput.type = 'password';
            toggleButton.textContent = 'üëÅÔ∏è';
        }
    }
    
    function toggleConfirmPassword() {
        const confirmInput = document.getElementById('confirm-password');
        const toggleButton = document.querySelectorAll('.toggle-password')[1];
        
        if (confirmInput.type === 'password') {
            confirmInput.type = 'text';
            toggleButton.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è';
        } else {
            confirmInput.type = 'password';
            toggleButton.textContent = 'üëÅÔ∏è';
        }
    }
    
    function selectRole(role) {
        document.getElementById(`role-${role}`).checked = true;
        
        if (role === 'admin') {
            document.getElementById('admin-note').style.display = 'block';
            if (typeof askQuestion === 'function') {
                setTimeout(() => {
                    askQuestion('Can I register as admin?');
                }, 500);
            }
        } else {
            document.getElementById('admin-note').style.display = 'none';
        }
    }
    
    function checkPasswordStrength() {
        const password = document.getElementById('password').value;
        const strengthBar = document.querySelector('.strength-bar');
        const strengthText = document.getElementById('strength-text');
        const requirements = {
            length: document.getElementById('req-length'),
            uppercase: document.getElementById('req-uppercase'),
            lowercase: document.getElementById('req-lowercase'),
            number: document.getElementById('req-number'),
            special: document.getElementById('req-special')
        };
        
        let strength = 0;
        let totalRequirements = 5;
        let metRequirements = 0;
        
        // Check requirements
        if (password.length >= 8) {
            requirements.length.classList.add('valid');
            metRequirements++;
        } else {
            requirements.length.classList.remove('valid');
        }
        
        if (/[A-Z]/.test(password)) {
            requirements.uppercase.classList.add('valid');
            metRequirements++;
        } else {
            requirements.uppercase.classList.remove('valid');
        }
        
        if (/[a-z]/.test(password)) {
            requirements.lowercase.classList.add('valid');
            metRequirements++;
        } else {
            requirements.lowercase.classList.remove('valid');
        }
        
        if (/[0-9]/.test(password)) {
            requirements.number.classList.add('valid');
            metRequirements++;
        } else {
            requirements.number.classList.remove('valid');
        }
        
        if (/[^A-Za-z0-9]/.test(password)) {
            requirements.special.classList.add('valid');
            metRequirements++;
        } else {
            requirements.special.classList.remove('valid');
        }
        
        // Calculate strength
        const percentage = (metRequirements / totalRequirements) * 100;
        strengthBar.style.width = `${percentage}%`;
        
        // Update text and color
        if (percentage === 0) {
            strengthBar.style.background = '#ff4444';
            strengthText.textContent = 'None';
            strengthText.style.color = '#ff4444';
        } else if (percentage <= 40) {
            strengthBar.style.background = '#ff4444';
            strengthText.textContent = 'Weak';
            strengthText.style.color = '#ff4444';
        } else if (percentage <= 70) {
            strengthBar.style.background = '#ffbb33';
            strengthText.textContent = 'Fair';
            strengthText.style.color = '#ffbb33';
        } else if (percentage <= 90) {
            strengthBar.style.background = '#00C851';
            strengthText.textContent = 'Good';
            strengthText.style.color = '#00C851';
        } else {
            strengthBar.style.background = '#007E33';
            strengthText.textContent = 'Strong';
            strengthText.style.color = '#007E33';
        }
        
        passwordValid = metRequirements >= 4; // At least 4 requirements met
        checkFormValidity();
    }
    
    function checkPasswordMatch() {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const matchElement = document.getElementById('password-match');
        
        if (!password) {
            matchElement.textContent = 'Please enter a password first';
            matchElement.style.color = '#ff4444';
            passwordsMatch = false;
        } else if (password === confirmPassword) {
            if (confirmPassword.length > 0) {
                matchElement.textContent = '‚úì Passwords match';
                matchElement.style.color = '#00C851';
                passwordsMatch = true;
            } else {
                matchElement.textContent = '';
                passwordsMatch = false;
            }
        } else {
            matchElement.textContent = '‚úó Passwords do not match';
            matchElement.style.color = '#ff4444';
            passwordsMatch = false;
        }
        
        checkFormValidity();
    }
    
    function validateEmail() {
        const email = document.getElementById('email').value;
        const emailError = document.getElementById('email-error');
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (!email) {
            emailError.textContent = '';
            emailValid = false;
        } else if (!emailRegex.test(email)) {
            emailError.textContent = 'Please enter a valid email address';
            emailError.style.color = '#ff4444';
            emailValid = false;
        } else if (!email.toLowerCase().endsWith('.edu') && !email.includes('example.com')) {
            emailError.textContent = '‚ö†Ô∏è University email preferred for student accounts';
            emailError.style.color = '#ffbb33';
            emailValid = true;
        } else {
            emailError.textContent = '‚úì Valid email format';
            emailError.style.color = '#00C851';
            emailValid = true;
        }
        
        checkFormValidity();
    }
    
    function checkFormValidity() {
        const submitBtn = document.getElementById('submit-btn');
        const termsChecked = document.getElementById('terms').checked;
        
        if (emailValid && passwordValid && passwordsMatch && termsChecked) {
            submitBtn.disabled = false;
        } else {
            submitBtn.disabled = true;
        }
    }
    
    function fillDemo(role) {
        if (role === 'admin') {
            document.getElementById('name').value = 'Administrator';
            document.getElementById('email').value = 'admin@example.com';
            document.getElementById('password').value = 'admin123';
            document.getElementById('confirm-password').value = 'admin123';
            document.getElementById('role-admin').checked = true;
            selectRole('admin');
        } else if (role === 'student') {
            document.getElementById('name').value = 'Test Student';
            document.getElementById('email').value = 'student@example.com';
            document.getElementById('password').value = 'student123';
            document.getElementById('confirm-password').value = 'student123';
            document.getElementById('role-student').checked = true;
            selectRole('student');
        }
        
        // Trigger validation checks
        checkPasswordStrength();
        checkPasswordMatch();
        validateEmail();
        
        // Show success message
        const message = document.createElement('div');
        message.className = 'alert alert-success alert-dismissible fade show mt-3';
        message.innerHTML = `
            ‚úÖ Demo ${role} credentials filled! Review and submit the form.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.form-grid').insertBefore(message, document.querySelector('.terms-group'));
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (message.parentNode) {
                message.remove();
            }
        }, 5000);
    }
    
    function showTerms() {
        if (typeof toggleChat === 'function') {
            toggleChat();
            setTimeout(() => {
                document.getElementById('chat-input').value = 'What are the terms of service?';
                sendMessage();
            }, 300);
        } else {
            alert('Terms of Service: By registering, you agree to follow university policies and event guidelines.');
        }
    }
    
    function showPrivacy() {
        if (typeof toggleChat === 'function') {
            toggleChat();
            setTimeout(() => {
                document.getElementById('chat-input').value = 'What is your privacy policy?';
                sendMessage();
            }, 300);
        } else {
            alert('Privacy Policy: We protect your personal information and only use it for event management purposes.');
        }
    }
    
    // Form submission handling
    document.getElementById('registerForm').addEventListener('submit', function(e) {
        const termsChecked = document.getElementById('terms').checked;
        
        if (!termsChecked) {
            e.preventDefault();
            showError('Please agree to the Terms of Service and Privacy Policy');
            return;
        }
        
        if (!passwordValid) {
            e.preventDefault();
            showError('Please create a stronger password (meet at least 4 requirements)');
            return;
        }
        
        if (!passwordsMatch) {
            e.preventDefault();
            showError('Passwords do not match');
            return;
        }
        
        // Show loading state
        const submitBtn = document.getElementById('submit-btn');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnSpinner = submitBtn.querySelector('.btn-spinner');
        
        btnText.style.display = 'none';
        btnSpinner.style.display = 'flex';
        submitBtn.disabled = true;
    });
    
    function showError(message) {
        // Remove any existing error alerts
        const existingAlerts = document.querySelectorAll('.alert-danger');
        existingAlerts.forEach(alert => alert.remove());
        
        // Create new error alert
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
        alertDiv.innerHTML = `
            ‚ùå ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const form = document.getElementById('registerForm');
        form.querySelector('.form-grid').insertBefore(alertDiv, form.querySelector('.form-grid').firstChild);
        
        // Shake animation
        form.classList.add('shake');
        setTimeout(() => {
            form.classList.remove('shake');
        }, 500);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-focus on name field
        document.getElementById('name').focus();
        
        // Add event listeners for real-time validation
        document.getElementById('terms').addEventListener('change', checkFormValidity);
        
        // Add chatbot hint
        setTimeout(() => {
            if (typeof addMessage === 'function') {
                addMessage("üí° <strong>Registration Tip:</strong> Use demo accounts for quick testing or ask me about account types!", 'bot');
            }
        }, 2000);
    });
</script>
{% endblock %}
