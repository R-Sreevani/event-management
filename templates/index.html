{% extends 'layout.html' %}
{% block title %}Home{% endblock %}

{% block content %}
<!-- Header -->
<div style="text-align: center; padding: 40px 20px;">
    <h1 style="
        font-size: 36px;
        font-weight: bold;
        color: #4a148c;
        margin-bottom: 10px;
    ">
        ğŸª Central University Event Hub
    </h1>
    <p style="font-size: 18px; color: #555; margin-bottom: 15px;">
        Your gateway to exciting university events and activities
    </p>
    <div style="display: inline-flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-top: 10px;">
        <span style="background: #e3f2fd; padding: 5px 15px; border-radius: 20px; font-size: 14px;">ğŸ“ Student Events</span>
        <span style="background: #f3e5f5; padding: 5px 15px; border-radius: 20px; font-size: 14px;">ğŸ¯ Workshops</span>
        <span style="background: #e8f5e8; padding: 5px 15px; border-radius: 20px; font-size: 14px;">ğŸ¤ Seminars</span>
        <span style="background: #fff3e0; padding: 5px 15px; border-radius: 20px; font-size: 14px;">ğŸ­ Cultural</span>
    </div>
</div>

<!-- Main Action Cards -->
<div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin: 30px 20px;">
    <div style="
        background: linear-gradient(135deg, #1976d2, #0d5cb6);
        color: white;
        padding: 30px;
        border-radius: 15px;
        width: 250px;
        text-align: center;
        box-shadow: 0 8px 20px rgba(25, 118, 210, 0.2);
        transition: transform 0.3s;
    " onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
        <div style="font-size: 40px; margin-bottom: 15px;">ğŸ“</div>
        <h3 style="margin-bottom: 10px;">Register</h3>
        <p style="font-size: 14px; opacity: 0.9; margin-bottom: 20px;">Create your account to join events</p>
        <a href="{{ url_for('register') }}">
            <button style="
                background: white;
                color: #1976d2;
                padding: 10px 20px;
                border: none;
                border-radius: 25px;
                font-weight: bold;
                cursor: pointer;
                width: 100%;
            ">Get Started</button>
        </a>
    </div>

    <div style="
        background: linear-gradient(135deg, #7b1fa2, #6a1b9a);
        color: white;
        padding: 30px;
        border-radius: 15px;
        width: 250px;
        text-align: center;
        box-shadow: 0 8px 20px rgba(123, 31, 162, 0.2);
        transition: transform 0.3s;
    " onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
        <div style="font-size: 40px; margin-bottom: 15px;">ğŸ”</div>
        <h3 style="margin-bottom: 10px;">Login</h3>
        <p style="font-size: 14px; opacity: 0.9; margin-bottom: 20px;">Access your dashboard and events</p>
        <a href="{{ url_for('login') }}">
            <button style="
                background: white;
                color: #7b1fa2;
                padding: 10px 20px;
                border: none;
                border-radius: 25px;
                font-weight: bold;
                cursor: pointer;
                width: 100%;
            ">Sign In</button>
        </a>
    </div>

    <div style="
        background: linear-gradient(135deg, #2E7D32, #1B5E20);
        color: white;
        padding: 30px;
        border-radius: 15px;
        width: 250px;
        text-align: center;
        box-shadow: 0 8px 20px rgba(46, 125, 50, 0.2);
        transition: transform 0.3s;
    " onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
        <div style="font-size: 40px; margin-bottom: 15px;">ğŸ¤–</div>
        <h3 style="margin-bottom: 10px;">AI Assistant</h3>
        <p style="font-size: 14px; opacity: 0.9; margin-bottom: 20px;">Get instant help about events</p>
        <button onclick="toggleChat()" style="
            background: white;
            color: #2E7D32;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        ">Ask Assistant</button>
    </div>
</div>

<!-- Event List -->
<div style="max-width: 900px; margin: 40px auto; padding: 0 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
        <h2 style="color: #6a1b9a; font-size: 26px; margin: 0;">
            ğŸ‰ Upcoming Events
        </h2>
        <div style="font-size: 14px; color: #666; background: #f0f4ff; padding: 8px 15px; border-radius: 20px;">
            ğŸ“… {{ now.strftime('%B %d, %Y') }} &nbsp; | &nbsp; ğŸ•’ {{ now.strftime('%I:%M %p') }}
        </div>
    </div>

    {% if events %}
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px;">
        {% for event in events %}
        <div style="
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border-top: 4px solid #7e57c2;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        " onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.12)'" 
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.08)'">
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <div style="
                    background: #ede7f6;
                    width: 50px;
                    height: 50px;
                    border-radius: 10px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-right: 15px;
                    font-size: 24px;
                ">
                    ğŸ¯
                </div>
                <div>
                    <h3 style="font-size: 20px; color: #333; margin: 0 0 5px 0;">{{ event.name }}</h3>
                    <div style="font-size: 14px; color: #666; display: flex; align-items: center; gap: 10px;">
                        <span>ğŸ“ University Event</span>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 8px; color: #555;">
                    <span style="font-size: 20px;">ğŸ“…</span>
                    <span>{{ event.date }}</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; color: #555;">
                    <span style="font-size: 20px;">ğŸ“</span>
                    <span>{{ event.venue }}</span>
                </div>
            </div>
            
            <button onclick="askAboutEvent('{{ event.name }}')" style="
                background: #f5f5f5;
                color: #7e57c2;
                border: 1px solid #ddd;
                padding: 10px 15px;
                border-radius: 8px;
                font-weight: bold;
                cursor: pointer;
                width: 100%;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            " onmouseover="this.style.background='#7e57c2'; this.style.color='white'" 
               onmouseout="this.style.background='#f5f5f5'; this.style.color='#7e57c2'">
                ğŸ¤– Ask About This Event
            </button>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div style="
        text-align: center;
        padding: 50px 20px;
        background: #f9f9f9;
        border-radius: 12px;
        margin: 30px 0;
    ">
        <div style="font-size: 60px; margin-bottom: 20px;">ğŸ“…</div>
        <h3 style="color: #666; margin-bottom: 10px;">No events scheduled yet</h3>
        <p style="color: #888; max-width: 500px; margin: 0 auto;">
            Check back soon for upcoming events or ask our assistant about event schedules.
        </p>
    </div>
    {% endif %}
</div>

<!-- Chatbot integrated into the page -->
<div id="chatbot-container">
    <div id="chat-window" style="display: none;">
        <div class="chat-header">
            <strong>Event Assistant ğŸ¤–</strong>
            <button onclick="toggleChat()" class="close-btn">Ã—</button>
        </div>
        <div id="chat-messages">
            <div class="message bot">Welcome to Central University Event Hub! ğŸ‘‹</div>
            <div class="message bot">I'm your virtual assistant. I can help you with:
                <ul style="margin: 5px 0 5px 20px;">
                    <li>Event information</li>
                    <li>Registration process</li>
                    <li>Login assistance</li>
                    <li>Upcoming schedules</li>
                </ul>
            </div>
            <div class="message bot">Try asking: "What events are coming up?" or "How do I register?"</div>
        </div>
        <div class="quick-questions">
            <button onclick="askQuestion('What events are coming up?')" class="quick-btn">ğŸ“… Events</button>
            <button onclick="askQuestion('How do I register?')" class="quick-btn">ğŸ“ Register</button>
            <button onclick="askQuestion('Login help')" class="quick-btn">ğŸ” Login</button>
            <button onclick="askQuestion('Contact admin')" class="quick-btn">ğŸ‘¨â€ğŸ’¼ Admin</button>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Ask me about university events..." 
                   onkeypress="if(event.keyCode==13) sendMessage()">
            <button onclick="sendMessage()" class="send-btn">Send</button>
        </div>
    </div>
    <button onclick="toggleChat()" class="chat-toggle-btn">
        <span class="chat-icon">ğŸ¤–</span>
        <span class="chat-label">Ask Assistant</span>
    </button>
</div>

<style>
/* Chatbot Styles */
#chatbot-container {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1000;
}

#chat-window {
    width: 380px;
    height: 520px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.chat-header {
    background: linear-gradient(135deg, #4a148c, #7b1fa2);
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.close-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.close-btn:hover {
    background: rgba(255,255,255,0.3);
}

#chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #f8f9fa;
    font-size: 14px;
}

.message {
    margin: 10px 0;
    padding: 12px 16px;
    border-radius: 18px;
    max-width: 85%;
    word-wrap: break-word;
    line-height: 1.4;
    animation: messageAppear 0.3s ease-out;
}

@keyframes messageAppear {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message.bot {
    background: white;
    color: #333;
    border: 1px solid #e0e0e0;
    margin-right: auto;
    border-bottom-left-radius: 5px;
}

.message.user {
    background: linear-gradient(135deg, #4a148c, #7b1fa2);
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 5px;
}

.quick-questions {
    padding: 15px 20px;
    background: white;
    border-top: 1px solid #eee;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
}

.quick-btn {
    background: #f0f2f5;
    border: 1px solid #ddd;
    padding: 6px 10px;
    border-radius: 15px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
}

.quick-btn:hover {
    background: #4a148c;
    color: white;
    border-color: #4a148c;
}

.chat-input-area {
    padding: 15px 20px;
    background: white;
    border-top: 1px solid #eee;
    display: flex;
    gap: 10px;
}

#chat-input {
    flex: 1;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 25px;
    outline: none;
    transition: border-color 0.3s;
}

#chat-input:focus {
    border-color: #4a148c;
}

.send-btn {
    background: linear-gradient(135deg, #4a148c, #7b1fa2);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-weight: bold;
    transition: transform 0.2s;
}

.send-btn:hover {
    transform: scale(1.05);
}

.chat-toggle-btn {
    background: linear-gradient(135deg, #4a148c, #7b1fa2);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 50px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: bold;
    box-shadow: 0 6px 20px rgba(74, 20, 140, 0.4);
    transition: all 0.3s;
    margin-left: auto;
}

.chat-toggle-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(74, 20, 140, 0.5);
}

.chat-icon {
    font-size: 18px;
}

.chat-label {
    font-size: 14px;
}

/* Responsive design */
@media (max-width: 768px) {
    #chat-window {
        width: calc(100vw - 60px);
        height: 450px;
        right: 30px;
    }
    
    .chat-toggle-btn {
        padding: 10px 15px;
    }
    
    .chat-label {
        display: none;
    }
}

/* Stats Counter Animation */
@keyframes countUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>

<script>
let chatOpen = false;
// FIX: Create a safe event data structure for JavaScript
let eventData = [];
{% if events %}
// Convert events to JavaScript array
eventData = [
    {% for event in events %}
    {
        name: "{{ event.name|safe }}",
        date: "{{ event.date|safe }}",
        venue: "{{ event.venue|safe }}"
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];
{% endif %}

function toggleChat() {
    const chatWindow = document.getElementById('chat-window');
    chatOpen = !chatOpen;
    chatWindow.style.display = chatOpen ? 'flex' : 'none';
    if (chatOpen) {
        // Auto-focus input when chat opens
        setTimeout(() => {
            document.getElementById('chat-input').focus();
        }, 100);
    }
}

function askQuestion(question) {
    document.getElementById('chat-input').value = question;
    sendMessage();
}

function askAboutEvent(eventName) {
    // Open chat if not open
    if (!chatOpen) {
        toggleChat();
        setTimeout(() => {
            document.getElementById('chat-input').value = `Tell me about ${eventName}`;
            sendMessage();
        }, 300);
    } else {
        document.getElementById('chat-input').value = `Tell me about ${eventName}`;
        sendMessage();
    }
}

function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message
    addMessage(message, 'user');
    input.value = '';
    
    // Show typing indicator
    const typingIndicator = document.createElement('div');
    typingIndicator.className = 'message bot';
    typingIndicator.id = 'typing';
    typingIndicator.innerHTML = 'Typing...';
    document.getElementById('chat-messages').appendChild(typingIndicator);
    document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
    
    // For home page, use client-side responses
    setTimeout(() => {
        // Remove typing indicator
        const typing = document.getElementById('typing');
        if (typing) typing.remove();
        
        // Generate response based on message
        let response = '';
        const msg = message.toLowerCase();
        
        if (msg.includes('event') || msg.includes('upcoming') || msg.includes('coming up') || msg.includes('schedule')) {
            if (eventData.length === 0) {
                response = "There are currently no upcoming events. Please check back later or contact the event organizers!";
            } else {
                response = `ğŸ“… There are ${eventData.length} upcoming events:\n\n`;
                eventData.forEach(event => {
                    response += `â€¢ **${event.name}**\n  Date: ${event.date}\n  Venue: ${event.venue}\n\n`;
                });
                response += "Click on any event card to learn more about it!";
            }
        } else if (msg.includes('register') || msg.includes('sign up') || msg.includes('signup')) {
            response = "ğŸ“ **How to Register:**\n\n1. Click the 'Get Started' button on the homepage\n2. Fill in your details (name, email, password)\n3. Verify your email (if required)\n4. Login to your account\n5. Browse events and register for any you're interested in!\n\nNeed help? Contact the admin at admin@university.edu";
        } else if (msg.includes('login') || msg.includes('sign in') || msg.includes('signin')) {
            response = "ğŸ” **Login Instructions:**\n\n1. Click the 'Sign In' button\n2. Enter your registered email and password\n3. If you're an admin, use the admin credentials provided to you\n4. Forgot password? Click 'Forgot Password' link\n\nTest credentials:\nâ€¢ Student: student@example.com / password123\nâ€¢ Admin: admin@example.com / admin123";
        } else if (msg.includes('admin') || msg.includes('contact') || msg.includes('help')) {
            response = "ğŸ‘¨â€ğŸ’¼ **Admin Contact:**\n\nâ€¢ Email: admin@university.edu\nâ€¢ Phone: +1 (555) 123-4567\nâ€¢ Office: University Admin Building, Room 101\nâ€¢ Hours: Mon-Fri, 9 AM - 5 PM\n\nFor urgent matters, please call or visit in person.";
        } else if (msg.includes('hello') || msg.includes('hi') || msg.includes('hey')) {
            response = "ğŸ‘‹ Hello! Welcome to Central University Event Hub. I'm your virtual assistant. How can I help you today? You can ask about events, registration, login, or contact information!";
        } else {
            // Check if message contains any event names
            const matchedEvents = eventData.filter(event => 
                msg.includes(event.name.toLowerCase()) || 
                event.name.toLowerCase().includes(msg)
            );
            
            if (matchedEvents.length > 0) {
                const event = matchedEvents[0];
                response = `ğŸ¯ **${event.name}**\n\n`;
                response += `ğŸ“… **Date:** ${event.date}\n`;
                response += `ğŸ“ **Venue:** ${event.venue}\n\n`;
                response += "To participate in this event:\n1. Register an account (if you haven't)\n2. Login to your account\n3. Find this event and click 'Register'\n\nFor more specific details, please contact the event organizers.";
            } else {
                response = "ğŸ¤” I'm not sure I understand. Here's what I can help you with:\n\nâ€¢ **Events** - Ask about upcoming events\nâ€¢ **Registration** - How to create an account\nâ€¢ **Login** - How to access your account\nâ€¢ **Contact** - Admin contact information\n\nTry asking: 'What events are coming up?' or 'How do I register?'";
            }
        }
        
        addMessage(response, 'bot');
    }, 800);
}

function addMessage(text, sender) {
    const messagesDiv = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    messageDiv.innerHTML = text.replace(/\n/g, '<br>');
    
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Auto-open chatbot after 5 seconds with welcome
setTimeout(() => {
    if (!chatOpen && eventData.length > 0) {
        const welcomeMessage = document.createElement('div');
        welcomeMessage.className = 'message bot';
        welcomeMessage.innerHTML = `ğŸ‘‹ Welcome! We have ${eventData.length} upcoming events. Ask me anything!`;
        document.getElementById('chat-messages').appendChild(welcomeMessage);
    }
}, 5000);
</script>
{% endblock %}
